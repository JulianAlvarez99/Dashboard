{% extends 'base.html' %}

{% block title %}Dashboard Principal{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
{# ── Bootstrap JSON data for Alpine.js (avoids quote-in-attribute bug) ── #}
<script>
    window.__filterConfigs = {{ filters | tojson | safe }};
    window.__widgetConfigs = {{ widgets | tojson | safe }};
    window.__apiBaseUrl    = {{ api_base_url | tojson | safe }};
</script>

<div x-data="dashboardApp(window.__filterConfigs, window.__widgetConfigs, window.__apiBaseUrl)"
     class="dashboard-content-inner">

    {# ── Error alert ──────────────────────────────────────────── #}
    {% if error_message %}
    {% include 'dashboard/partials/_error_alert.html' %}
    {% endif %}

    {# ══════════════════════════════════════════════════════════ #}
    {#  FILTERS PANEL                                            #}
    {# ══════════════════════════════════════════════════════════ #}
    {% if filters %}
    {% include 'dashboard/partials/_filters_panel.html' %}
    {% else %}
    <div class="empty-state">
        <p class="empty-state-title">No hay filtros configurados para este dashboard.</p>
    </div>
    {% endif %}

    {# ══════════════════════════════════════════════════════════ #}
    {#  WIDGETS GRID                                             #}
    {# ══════════════════════════════════════════════════════════ #}
    {% if widgets %}
    <div id="widgets-container" class="widgets-grid">
        {% for widget in widgets %}
        {% if widget %}
        {% set wl = widget_layout.get(widget.widget_type_inferred, widget_layout.get('unknown', {})) %}
        {% set size_class = widget_layout_sizes.get(wl.get('size','small'), 'widget-sm') %}
        {% set chart_h = wl.get('chart_height') or '250px' %}
        {% set wid = widget.widget_id %}
        {% set wtype = widget.widget_type_inferred %}

        <div class="{{ size_class }}" style="order:{{ wl.get('order', 99) }}">
            <div class="widget" id="widget-{{ wid }}">

                {# ── Loading skeleton ── #}
                <div x-show="!widgetResults['{{ wid }}']" class="widget-loading">
                    <div class="widget-skeleton-bar"></div>
                    <div class="widget-skeleton-bar"></div>
                </div>

                {# ── Empty state ── #}
                <div x-show="widgetResults['{{ wid }}'] && widgetResults['{{ wid }}'].metadata && widgetResults['{{ wid }}'].metadata.empty"
                     x-cloak
                     class="widget-body" style="align-items:center;justify-content:center">
                    <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400"
                       x-text="(widgetResults['{{ wid }}'] && widgetResults['{{ wid }}'].metadata && widgetResults['{{ wid }}'].metadata.message) || 'No hay datos disponibles'"></p>
                </div>

                {# ── Widget type partials (server-time decision) ── #}
                {% if wtype.startswith('kpi_') %}
                    {% include 'dashboard/partials/_widget_kpi.html' %}
                {% elif wtype in ('line_chart', 'bar_chart', 'pie_chart', 'comparison_bar', 'scatter_chart') %}
                    {% include 'dashboard/partials/_widget_chart.html' %}
                {% elif 'table' in wtype or wtype == 'product_ranking' %}
                    {% include 'dashboard/partials/_widget_table.html' %}
                {% elif wtype == 'line_status' %}
                    {% include 'dashboard/partials/_widget_line_status.html' %}
                {% elif wtype == 'metrics_summary' %}
                    {% include 'dashboard/partials/_widget_metrics_summary.html' %}
                {% else %}
                    {% include 'dashboard/partials/_widget_unknown.html' %}
                {% endif %}

            </div>{# /.widget #}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
        </svg>
        <p class="empty-state-title">No hay widgets configurados para este dashboard.</p>
        <p class="empty-state-description">
            Configura los widgets en la tabla <code class="empty-state-code">DASHBOARD_TEMPLATE</code>.
        </p>
    </div>
    {% endif %}
</div>

{# ── External JS (extracted from inline) ── #}
<script src="{{ url_for('static', filename='js/chart-renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard-app.js') }}"></script>
{% endblock %}
